<!DOCTYPE html>
<html>
  <head>
    <title>Chat!</title>

    <meta charset="utf-8" />
  </head>

  <body>
    <h3>WebSocket Only Authentication</h3>
    <div id=connectionStatus>connecting</div>
    <hr />
    <div id=content></div>
  
    <script>
      const uri = `ws://${window.location.host}/ws/`

      let ws
      
      const send = (data) => ws.send(JSON.stringify(data))

      const connect = (init = false) => {
        connectionStatus.innerHTML = init ? 'connecting' : 'reconnecting'

        ws = new WebSocket(uri)

        ws.onclose = () => setTimeout(connect, 1000) // Reconnect

        ws.onmessage = (event) => {
          const { type, ...data } = JSON.parse(event.data)
          content.innerHTML = handlers[type]
            ? handlers[type](data)
            : `Unknown response ${type}`
        }

        ws.onopen = () => {
          connectionStatus.innerHTML = 'connected'
          const token = localStorage.getItem('token')
          if (token) send({ type: 'RefreshToken', token })
          else content.innerHTML = handlers.NotLoggedIn()
        }
      }

      const handleLogin = (e) => {
        e.preventDefault()
        send({
          type: 'Login',
          username: username.value,
          password: password.value
        })
      }

      const logout = () => {
        const token = localStorage.getItem('token')
        localStorage.removeItem('token')
        send({
          type: 'Logout',
          token
        })
      }

      const authSuccess = ({ token }) => {
        localStorage.setItem('token', token)
        return `
          <div>
            User authorized with token
            <a target=_blank href="https://jwt.io?token=${token}">
              <code>${token}</code>
            </a>
          </div>
          <br />
          <button onclick=logout()>Logout</button>`
      }

      loggedOut = () => `
        <form onsubmit="return handleLogin(event)">
          <p>Login or register</p>
          <div><input placeholder=Username id=username type=text /></div>
          <br/>
          <div><input placeholder=Password id=password type=password /></div>
          <br/>
          <input type=submit />
        </form>`

      const handlers = {
        InvalidRequest: () => 'Invalid Request',
        NotLoggedIn: loggedOut,
        LoggedOut: loggedOut,
        Registered: authSuccess,
        Success: authSuccess
      }

      connect(true)
    </script>
    <!-- <div>
      <button id="btn_connect">Connect</button>
      Status: <span id="span_status">disconnected</span>
    </div>

    <div id=credentials>
      <form>
        <input type=text />
        <input type=password />
        <button>Authorize</button>
      </form>
    </div>

    <div
      id="div_log"
      style="width: 20em; height: 15em; overflow: auto; border: 1px solid black"
    ></div> -->
  </body>
</html>
